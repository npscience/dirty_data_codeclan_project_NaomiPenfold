---
title: "Data exploration"
output: html_notebook
---

```{r}
library(tidyverse)
library(readxl)
library(janitor)
```
# Load in raw data

```{r}
sheet_names <- excel_sheets(here::here("raw_data/seabirds.xls"))
```

```{r}
ship_data <- read_excel(here::here("raw_data/seabirds.xls"), sheet = "Ship data by record ID")
bird_data <- read_excel(here::here("raw_data/seabirds.xls"), sheet = "Bird data by record ID")
ship_codes <- read_excel(here::here("raw_data/seabirds.xls"), sheet = "Ship data codes")
bird_codes <- read_excel(here::here("raw_data/seabirds.xls"), sheet = "Bird data codes")
```

Note the error this flagged - it may mean that there is a column that contains mixed type data, or that data has spilled across columns. Tbc when I inspect the subset of data I need for this analysis.


# Analysis planning

## Requested insights

* Which bird had the most individual sightings?
* Which bird had the highest total count?
* Which bird had the highest total count above a latitude of -30?
* How many different types of birds were only ever seen in groups of 1?
* How many penguins were seen? (Hint: there are many types of penguin)

For each question where we ask for bird names, give the bird’s common name, scientific name and species abbreviation.

## Gather required data

1. Join ship_data and bird_data by `RECORD ID` - this is the common key that links the ship data (date of sightings, from which ship, at which lat/long position, who sighted, weather conditions, etc) with the bird data (which bird sighted, how many counted in the sighting, etc). I have decided to left join, to keep all the bird data, and only match ship data where there is a match (I don't need any ship records that don't match up to recorded bird sightings).

2. Retain only the following columns (for the above analysis questions) & rename for tidy data, to create a dataframe like this:

| record_id | ship_lat | common_name | sci_name | species_abbrv | count |

```{r}
bird_counts <-  left_join(bird_data, ship_data, by = "RECORD ID") # expect all 49,019 bird observations

bird_counts <- bird_counts %>% 
  select(`RECORD ID`, LAT, `Species common name (taxon [AGE / SEX / PLUMAGE PHASE])`, `Species  scientific name (taxon [AGE /SEX /  PLUMAGE PHASE])`, `Species abbreviation`, COUNT) %>% 
  clean_names() %>% 
  rename(
   common_name = species_common_name_taxon_age_sex_plumage_phase,
   sci_name = species_scientific_name_taxon_age_sex_plumage_phase
  )

glimpse(bird_counts)

# write subset of raw data to new csv file to continue with in next cleaning script
# write_csv(bird_counts, "data/bird_counts_raw.csv")
```
* Note that text columns are character type, numeric columns are <dbl>. This means any NAs or missing values in numeric columns are standard NAs, blanks or numbers - i.e. no entries written in as 'none' for example.


## Cleaning tasks: plan

### 1 explore missing values and strange data

[x] Find standard NAs for all
[x] check for non-standard NAs in character data: From codes data, expect:
    [x] blanks for missing latitude values 
    [x] [NO BIRDS RECORDED] in common_name (and _NA_ in sci_name and species_abbreviation) for observations with no sightings
[x] check numeric data:
  [x] check min and max make sense for latitudes and counts
  [x] check record ids, to ensure we have kept all sightings after the join: expect 1083001 - 85030012 for both birds and ships data

### 2 Plan for cleaning and recoding within data

Cleaning the character data in common_name and sci_name: 

* common_name: remove 'sensu lato' =  latin for "in the broad sense" ? 
* common_name and sci_name: remove age codes: AD, JUV, IMM ?
* common_name and sci_name: remove plummage codes: PL# ?
* Note some bird1 / bird 2 / ... -- explore how many have / and what to do about counting these
* do distinct() to see if any more need recording
* ?? create a new column with data recoded by species (e.g. Penguin) to include specifically identified and unidentified birds within the same species, ready for counting by species
  
To note during analyses:

* For observations where NO BIRDS RECORDED, these can be filtered out by excluding _NA_ in species_abbreviation
* Note NAs in sci_name are either "NO BIRDS RECORDED" or "<Species> (unidentified)" in common_name

### 3 Plan for assertive programming

Assertive programming to check input data is valid before analysing:

* verify common_name, sci_name, species_abbreviation are character type
* verify lat, count are numeric type
* verify lat range: -90 to + 90
* verify count range: 1 to 99,999 (since this is how data is meant to be encoded)
* do not do anything to verify record ID, to keep open for any IDs
  
  
## Cleaning tasks: exploration

### Find standard NAs
```{r}
bird_counts %>% 
  summarise(across(.cols = everything(),
                   .fns = ~ sum(is.na(.x))))
```
Note: NAs in several columns we want to use in analysis, tbc how to deal with these during analysis.

### Check numeric ranges
```{r}
min_lat <- bird_counts %>% 
  select(lat) %>% 
  filter(!is.na(lat)) %>% 
  min()

max_lat <- bird_counts %>% 
  select(lat) %>% 
  filter(!is.na(lat)) %>% 
  max()

min_count <- bird_counts %>% 
  select(count) %>% 
  filter(!is.na(count)) %>% 
  min()

max_count <- bird_counts %>% 
  select(count) %>% 
  filter(!is.na(count)) %>% 
  max()

min_id <- bird_counts %>% 
  select(record_id) %>% 
  min()

max_id <- bird_counts %>% 
  select(record_id) %>% 
  max()

min_lat
max_lat
min_count
max_count
min_id
max_id
```
#### Latitude

Latitude ranges -69 to -19, which is within normal range for latitudes in Southern hemisphere (from ship codes data: "S hemisphere: -90 to 0").

**Outcome: no cleaning required; for assertive programming, verify lat is numeric type and in range -90 to + 90.**

#### Count

Counts range from 1 to 99,999. This upper limit seems unreasonable - inspect the top counts data:

```{r}
bird_counts %>% 
  filter(!is.na(count)) %>% 
  arrange(desc(count)) %>% 
  head(n = 50)
```
Six records with 99,999 as count (mostly puffins), then several records with 10,000 - 50,000. The bird codes data notes that count is "Total no of individuals counted in 10 min (1 – 50,000; 99999 = over 100,000). Therefore, these high values are real, do not discount as errors / missing values. However, do take this encoding into account when calculating counts (at least <calculated value>).

**Outcome: no cleaning required; for assertive programming, verify count is numeric type and in range: 1 to 99,999 (since this is how data is meant to be encoded).**

#### Record ID

We expect to have record IDs from 1083001 - 85030012; we have 1083001 (correct lower limit) to 88007036 (higher than expected max).

Inspect IDs above the expected upper limit:

```{r}
bird_counts %>% 
  filter(record_id >= 85030012) 
```

There are 8,869 bird sightings above the expected upper limit for record ID, as per the codes data - this looks real, and I assume more data has been collected since the codes data sheets were written.

**Outcome: no cleaning required; do not include any verification in assertive programming.**

### Inspect for blanks / encoded missing data

#### Any blanks in latitude?

Expect: <blank> for missing values in latitude, according to ship codes data.

```{r}
# Find blanks in latitude by filtering outside known min and max values
bird_counts %>% 
  filter(lat < min_lat | lat > max_lat)

# Find blanks in latitude by looking for ""
bird_counts %>% 
  filter(lat == "")
```

No blanks found, I assume this means no missing latitude values.

#### Any missing data in bird counts (in name columns)?

Expect: [NO BIRDS RECORDED] in common_name (and _NA_ in sci_name and species_abbreviation) for observations with no sightings, according to bird codes data.

```{r}
# Find "[NO BIRDS RECORDED]"
bird_counts %>% 
  arrange(desc(common_name))
# shows many matches

# count how many
bird_counts %>% 
  mutate(missing = str_detect(common_name, "NO BIRDS RECORDED")) %>% 
  filter(missing == TRUE) # 691 rows

# check if other columns contain NA for all
bird_counts %>% 
  mutate(missing = str_detect(common_name, "NO BIRDS RECORDED")) %>% 
  filter(missing == TRUE) %>%
  summarise(across(.cols = c(sci_name, species_abbreviation, count),
            .fns = ~ sum(is.na(.x))))
```

There are 691 observations whereby no birds were recorded. For these, all have _NA_ in sci_name, species_abbreviation and count. 

Since species_abbreviation has a total of 691 NAs (see table of NAs from earlier), we can use species_abbreviation = _NA_ to filter out "NO BIRDS RECORDED".

**Outcome: to remove "NO BIRDS RECORDED" when analysing, filter by excluding NAs in species_abbreviation**

sci_name has more than 691 _NA_ (from earlier), so there are more missing values to inspect here:
```{r}
# find additional NAs in sci_name
species_na <- bird_counts %>% 
  filter(!is.na(species_abbreviation)) %>% 
  filter(is.na(sci_name)) %>%  # 410 more NAs in sci_name
  group_by(species_abbreviation) %>% 
  summarise(n())

species_na

# create a vector with the species_abbreviations where sci_name is NA for a sighting
species_na_lookup <- species_na %>% 
  select(species_abbreviation) %>% 
  pull()

species_na_lookup
```
11 distinct species (by abbreviation) with NA in sci_name. 

Can I recode sci_name according to this abbreviation, if it exists elsewhere in the data? (And if not, see if I can find it online?). I note some of these look like they could be penguins (PENGUN, DRKPUN), which is important for the requested analyses.

Find all data for these species_abbreviations - is it always NA for sci_name?
```{r}
# Find all data for these species_abbreviations
bird_counts %>% 
  filter(species_abbreviation %in% species_na_lookup) # 410 observations

# Are they all NA in sci_name?
bird_counts %>% 
  filter(species_abbreviation %in% species_na_lookup) %>% 
  group_by(sci_name) %>% 
  summarise(n()) # all 410 are NA
```

All entries with these species abbreviations are also _NA_ in sci_name, so there is no existing additional data here by which I can recode sci_name from species_abbreviation. 

It looks like these are the cases with `(unidentified)` appended to `common_name`, including `Penguin (unidentified)` with `PENGUN` as `species_abbreviation`.

From this, I assume these (unidentified) birds are useful to retain as is, and ensure to include these in counts by species: I may need to look for several names when counting by species (e.g. specific Penguin species as well as these Penguin (unidentified) ones).
