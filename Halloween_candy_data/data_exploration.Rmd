---
title: "Data exploration"
output: html_notebook
---

```{r}
library(tidyverse)
library(readxl)
library(janitor)
```

# Load and inspect data

```{r}
excel_sheets("data/boing-boing-candy-2015.xlsx")
excel_sheets("data/boing-boing-candy-2016.xlsx")
excel_sheets("data/boing-boing-candy-2017.xlsx")
```

Each excel has only one sheet, each excel file is a dataset for one year. 

Read these in:
```{r}
x2015 <- read_excel("data/boing-boing-candy-2015.xlsx", sheet = "Form Responses 1")
x2016 <- read_excel("data/boing-boing-candy-2016.xlsx", sheet = "Form Responses 1")
x2017 <- read_excel("data/boing-boing-candy-2017.xlsx", sheet = "responses (2) (1).csv")
```


# Analysis questions

Note: more info on the data source [here](https://www.scq.ubc.ca/so-much-candy-data-seriously/).

1. What is the total number of candy ratings given across the three years. (Number of candy ratings, not the number of raters. Donâ€™t count missing values)
2. What was the average age of people who are going out trick or treating?
3. What was the average age of people who are not going trick or treating?
4. For each of joy, despair and meh, which candy bar received the most of these ratings?
5. How many people rated Starburst as despair?

For the next three questions, count despair as -1, joy as +1, and meh as 0.
6. What was the most popular candy bar by this rating system for each gender in the dataset ?
7. What was the most popular candy bar in each year?
8. What was the most popular candy bar by this rating for people in US, Canada, UK, and all other countries?

Which variables do we need to answer the analysis questions? We need:
* All candy ratings (1 rating of 1 candy bar by 1 rater in 1 year = 1 observation)
* Age of rater, where available
* Whether or not the rater goes out trick or treating
* To be able to summarise count of ratings (joy, meh, despair) for each candy bar
* Gender of rater, where available
* To be able to filter for Starburst and count despair ratings
* To be able to convert ratings to +1, 0, -1 and sum across these 3 (new column)
* To be able to group by year
* To be able to group by country

# Approach for joining data (and making it 'tidy' long format)

Step 1: Make tidy data: 
  * We want variables: rater_info (ToT_activity, age, gender, country), rating_year, type of candy bar <chr>, rating (joy, meh, despair) 
  * Make sure variables are in same (and desired) data type in all 3 dfs
  * add a column for year in each dataset
  * add column with NAs for any of the above variables where data does not exist in that year's df 

Step 2: Join the tidy dataframes (append rows)
* Try tidying each sheet first, then joining all 3 together. Then deal with inconsistent candy bar names in later cleaning step, i.e.:
  * Make matching variables and rated objects (candy bars) consistent across the 3 dataframes
  
Aim: I want to make one combined df. that looks like the following, whereby 1 rating of 1 candy item by 1 rater in 1 year = 1 observation:

| year <dttm( or int(YYYY)> | id <int> | age <int> | gender <chr> | country <chr> | goes_trick_or_treating <chr or lgl> | candy_item <chr> | rating <chr>  | [And later: rating_value <dbl>] |
|----|----|----|----|----|----|----|----|----|
| 2015 | 5058 | 23 | Male | USA | TRUE | Twix | JOY | 1 |
| 2016 | 1123 | 36 | Female | Canada | FALSE | Twix | DESPAIR | -1 |
| 2016 | 1123 | 36 | Female | Canada | FALSE | Trail mix | MEH | 0 |

## Variables, rows and data types

Here, I have inspected the variables within each year's dataset, and decided what to remove, what to keep and how to keep it, to achieve the above aim of combined tidy data.

### 2015

```{r}
ncol(x2015) # 124 columns
colnames(x2015)
```

```{r}
glimpse(x2015) # 5630 rows
# data types: mostly <chr>, some <lgl> at end, 1 <dttm> at beginning
```

Variables to keep/convert:

| Column # | Current variable name <type> | Action required to make tidy data |
| ----- | ----- | ----- |
| 1 | `Timestamp` <dttm> | Convert to `year` <dttm (YYYY)> |
| 2 | `How old are you?` <chr> | Convert to `age` <int> |
| 3 | `Are you going actually going trick or treating yourself?` <chr> |  Convert to `goes_trick_or_treating` <chr or lgl> |
| 4-17,19-22,24-25,29-32,35-37,39-40,42-44,46-55,57-81,83-89,91-92,96,114,115 | `Candy or other substance` <chr> | Remove non-candy items (see below) then make tidy -> `Candy_item` <chr> + `Rating` <chr> |
| 97,100-113,116-124 | Miscellaneous  | Remove |
| 98 | `Please list any items not included above that give you JOY.` | Extract answers --> new cols with JOY as value, and include in tidying step |
| 99 | `Please list any items not included above that give you DESPAIR.` | Extract answers --> new cols with DESPAIR as value, and include in tidying step |

Decisions on variables to keep/remove:

* Some are not candy (either obviously or by searching online), so removed:
  * Other food items, not candy: [34] `Healthy fruit`, [41] `Kale smoothie`, [56] `Minibags of chips` (crisps, not candy), [82] `Spotted Dick` (cake, not candy), [90] `Peanut butter jars` (nut butter, not candy), [94] `White bread`, [95] `Whole wheat anything`
  * Pharmaceuticals: [26] `[Generic Brand Acetaminophen]`, [93] `[Vicodin]`
  * other items, not food: [18] `Cash...`, [23] `Dental paraphenalia`, [27] `Glow sticks`, [28] `Broken glow stick`, [33] `Creepy Religious comics...`, [38] `Hugs...`, [45] `Lapel pins`
* Items kept in include candy that I recognise by name or have identified as candy by searching online, for example:
  * [63] `Pencils`, [88] `Peterson Brand sidewalk chalk`, [91] `Trail mix` - note decided to keep this in as it is a high sugar content snack.

```{r 2015-subset}
# keep wanted columns (except 98-99)
x2015_subset <- x2015 %>% 
  select(1:17,19:22,24,25,29:32,35:37,39:40,42:44,46:55,57:81,83:89,91,92,96,114,115)

head(x2015_subset) # 82 variables

# rename variables about the rater & rating year
# and reposition to end with: 
# [1]year [2]age [3]gender [4]country [5]goes_trick_or_treating
x2015_subset_converted <- x2015_subset %>% 
  rename(age = "How old are you?",
          goes_trick_or_treating = "Are you going actually going trick or treating yourself?",
          year = "Timestamp") %>% 
  mutate(age = as.integer(age), # note coerces 9.0e22 in row 9 to NA
         year = as.numeric(format(year, "%Y"))) %>% 
  # make empty columns for gender and country (missing in this year's dataset)
  mutate(gender = rep(NA_character_, nrow(x2015_subset)), .after = age) %>% 
  mutate(country = rep(NA_character_, nrow(x2015_subset)), .after = gender) %>% 
  # make an id column to retain unique identifier for each person
  mutate(id = c(1:5630), .before = age)

# Note: mutate(goes_trick_or_treating = as.logical(goes_trick_or_treating))
# coerces to NA, need different approach to make T/F

dim(x2015_subset_converted) # 85 cols x 5630 observations
head(x2015_subset_converted) # cols 1:6 are rater_info, 6_84 are candy items

# 'tidy' subsetted data to long format with
# one column for candy items [6:84], one column for rating
# expect 5630 x 85 to become 
# (5630 raters * 79 items) x 8 = 444,770 x 8
x2015_tidy <- x2015_subset_converted %>% 
  pivot_longer(cols = -c(year, id, age, gender, country, goes_trick_or_treating),
               names_to = "candy_item",
               values_to = "rating"
               )
dim(x2015_tidy) # 444,770 obs x 8 var - as expected
head(x2015_tidy, n = 20)
tail(x2015_tidy, n = 20)
```
NEXT: deal with column 98-99 in x2015 --> item & rating, with rater id.


### 2016

```{r}
ncol(x2016) # 123 columns
colnames(x2016)
```

```{r}
glimpse(x2016) # 1259 rows
# data types: mostly <chr>, 1 <lgl> at end, 1 <dttm> at beginning
```

### 2017

```{r}
ncol(x2017) # 120 columns
colnames(x2017)
```

```{r}
glimpse(x2017) # 2460 rows
# data types: mostly <chr>, some <dbl>, no <lgl>
```



## Check consistency of candy items in each year

```{r}
# list candy items in 2015 data
x2015_tidy %>% 
  distinct(candy_item)
```


# Inspect data within

* find missing values, NAs
* clean up country column - need USA, Canada, UK, all other countries
* clean up any other data, e.g. character

